# ä¸ªäººä¿¡æ¯ä¿®æ”¹å¯†ç é—®é¢˜ä¿®å¤è¯´æ˜

## é—®é¢˜æè¿°

ç”¨æˆ·åœ¨ä¸ªäººä¸»é¡µä¿®æ”¹ä¸ªäººä¿¡æ¯ï¼ˆå¦‚çœŸå®å§“åã€å­¦å·ã€ä¸“ä¸šç­‰ï¼‰åï¼Œæ— æ³•å†æ¬¡ç™»å½•ç³»ç»Ÿã€‚åç«¯åé¦ˆæ¯æ¬¡ç”¨æˆ·ä¿¡æ¯ä¿®æ”¹éƒ½ä¼šå¯¼è‡´å¯†ç è¢«æ„å¤–ä¿®æ”¹ã€‚

## æ ¹æœ¬åŸå› 

åœ¨`src/utils/userExtension.ts`æ–‡ä»¶çš„`prepareUserForBackend`å‡½æ•°ä¸­ï¼Œå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

### ä¿®å¤å‰çš„é”™è¯¯ä»£ç 
```typescript
export function prepareUserForBackend(user: User): any {
  const extension = extractUserExtension(user)
  const extensionString = stringifyUserExtension(extension)
  
  // âŒ é—®é¢˜ï¼šä½¿ç”¨è§£æ„èµ‹å€¼åï¼Œæ‰€æœ‰å­—æ®µéƒ½è¢«ä¼ é€’ç»™åç«¯
  const { realName, studentId, major, bio, tags, phone, preferences, stats, hasCompletedPreferences, ...baseUser } = user
  
  const result = {
    ...baseUser, // âŒ è¿™é‡ŒåŒ…å«äº†å¯†ç ç­‰æ•æ„Ÿå­—æ®µ
    extension: extensionString
  }
  
  return result
}
```

### é—®é¢˜åˆ†æ
1. **æ„å¤–ä¼ é€’å¯†ç **: é€šè¿‡`...baseUser`å±•å¼€æ“ä½œï¼Œç”¨æˆ·çš„æ‰€æœ‰å­—æ®µï¼ˆåŒ…æ‹¬å¯†ç ï¼‰éƒ½è¢«ä¼ é€’ç»™åç«¯
2. **ç¼ºä¹å­—æ®µæ§åˆ¶**: æ²¡æœ‰æ˜ç¡®æ§åˆ¶å“ªäº›å­—æ®µåº”è¯¥å‘é€ç»™åç«¯
3. **å®‰å…¨é£é™©**: å¯èƒ½ä¼ é€’å…¶ä»–æ•æ„Ÿä¿¡æ¯

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤åçš„æ­£ç¡®ä»£ç 
```typescript
export function prepareUserForBackend(user: User): any {
  const extension = extractUserExtension(user)
  const extensionString = stringifyUserExtension(extension)
  
  // âœ… ä¿®å¤ï¼šåªä¿ç•™å¿…è¦çš„åŸºç¡€å­—æ®µï¼Œæ˜ç¡®æ’é™¤å¯†ç å’Œå…¶ä»–æ•æ„Ÿå­—æ®µ
  const result = {
    user_id: user.user_id,
    username: user.username,
    email: user.email,
    avatar_url: user.avatar_url,
    role: user.role,
    password: "", // ğŸ”§ å…³é”®ä¿®å¤ï¼šå¯†ç å­—æ®µä¼ ç©ºå­—ç¬¦ä¸²ï¼Œè®©åç«¯çŸ¥é“ä¸ä¿®æ”¹å¯†ç 
    extension: extensionString
  }
  
  return result
}
```

### ä¿®å¤è¦ç‚¹
1. **æ˜ç¡®å­—æ®µæ§åˆ¶**: åªä¼ é€’å¿…è¦çš„åŸºç¡€å­—æ®µ
2. **å¯†ç å­—æ®µå¤„ç†**: æ˜ç¡®è®¾ç½®`password: ""`ï¼Œè®©åç«¯è¯†åˆ«ä¸éœ€è¦ä¿®æ”¹å¯†ç 
3. **å®‰å…¨ä¿æŠ¤**: é¿å…æ„å¤–ä¼ é€’æ•æ„Ÿä¿¡æ¯
4. **ç¬¦åˆåç«¯è¦æ±‚**: æ ¹æ®åç«¯æ¥å£æ–‡æ¡£ï¼Œç©ºå­—ç¬¦ä¸²è¡¨ç¤ºä¸ä¿®æ”¹å¯†ç 

## æ•°æ®å¯¹æ¯”

### ä¿®å¤å‰å‘é€çš„æ•°æ®ï¼ˆæœ‰é—®é¢˜ï¼‰
```json
{
  "user_id": 123,
  "username": "testuser",
  "email": "test@example.com",
  "password": "encrypted_password_hash", // âŒ åŒ…å«å¯†ç 
  "role": "student",
  "avatar_url": "/avatars/123.jpg",
  "realName": "å¼ ä¸‰",
  "studentId": "2021001",
  "major": "è®¡ç®—æœºç§‘å­¦",
  "bio": "ä¸ªäººç®€ä»‹",
  "tags": ["ç¼–ç¨‹", "AI"],
  "phone": "13800138000",
  "preferences": {...},
  "stats": {...},
  // ... å…¶ä»–æ‰€æœ‰å­—æ®µ
  "extension": "{...}"
}
```

### ä¿®å¤åå‘é€çš„æ•°æ®ï¼ˆæ­£ç¡®ï¼‰
```json
{
  "user_id": 123,
  "username": "testuser",
  "email": "test@example.com",
  "password": "", // âœ… ç©ºå­—ç¬¦ä¸²ï¼Œåç«¯çŸ¥é“ä¸ä¿®æ”¹å¯†ç 
  "role": "student",
  "avatar_url": "/avatars/123.jpg",
  "extension": "{\"realName\":\"å¼ ä¸‰\",\"studentId\":\"2021001\",\"major\":\"è®¡ç®—æœºç§‘å­¦\",\"bio\":\"ä¸ªäººç®€ä»‹\",\"tags\":[\"ç¼–ç¨‹\",\"AI\"],\"phone\":\"13800138000\"}"
}
```

## ä¿®å¤å½±å“çš„åŠŸèƒ½

### ç›´æ¥ä¿®å¤çš„åŠŸèƒ½
1. **ä¸ªäººä¿¡æ¯ç¼–è¾‘** (`UserCenterView.vue`)
   - ä¿®æ”¹çœŸå®å§“åã€å­¦å·ã€ä¸“ä¸šã€æ‰‹æœºå·ã€ä¸ªäººç®€ä»‹
   - ä¿®æ”¹åç”¨æˆ·å¯ä»¥æ­£å¸¸ç™»å½•

2. **åå¥½è®¾ç½®ä¿å­˜** (`UserCenterView.vue`)
   - ä¿å­˜å…´è¶£åˆ†ç±»ã€é€šçŸ¥è®¾ç½®ã€ç‰¹è´¨æ ‡ç­¾ç­‰
   - ä¿®æ”¹åç”¨æˆ·å¯ä»¥æ­£å¸¸ç™»å½•

### é—´æ¥å—ç›Šçš„åŠŸèƒ½
1. **ç¤¾å›¢æˆå‘˜ç®¡ç†**: ç®¡ç†å‘˜ä¿®æ”¹æˆå‘˜ä¿¡æ¯
2. **ç”¨æˆ·ç®¡ç†**: ç®¡ç†å‘˜ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯
3. **æ‰€æœ‰æ¶‰åŠç”¨æˆ·ä¿¡æ¯æ›´æ–°çš„åŠŸèƒ½**

## æµ‹è¯•éªŒè¯

### æµ‹è¯•é¡µé¢
è®¿é—® `/test-password-fix` é¡µé¢è¿›è¡Œå®Œæ•´æµ‹è¯•

### æµ‹è¯•æ­¥éª¤
1. ç™»å½•ç³»ç»Ÿ
2. è®¿é—®æµ‹è¯•é¡µé¢æŸ¥çœ‹å½“å‰ç”¨æˆ·ä¿¡æ¯
3. ä¿®æ”¹ä¸ªäººä¿¡æ¯ï¼ˆçœŸå®å§“åã€å­¦å·ç­‰ï¼‰
4. ç‚¹å‡»"æµ‹è¯•æ›´æ–°ä¿¡æ¯"
5. æŸ¥çœ‹å‘é€åˆ°åç«¯çš„æ•°æ®ç»“æ„
6. ç¡®è®¤æ›´æ–°æˆåŠŸ
7. é€€å‡ºç™»å½•
8. é‡æ–°ç™»å½•éªŒè¯å¯†ç æ˜¯å¦æ­£å¸¸

### é¢„æœŸç»“æœ
- âœ… ä¸ªäººä¿¡æ¯æ›´æ–°æˆåŠŸ
- âœ… å¯†ç å­—æ®µä¸ºç©ºå­—ç¬¦ä¸²
- âœ… åªä¼ é€’å¿…è¦å­—æ®µ
- âœ… é‡æ–°ç™»å½•æ­£å¸¸

## åç«¯é…åˆ

### åç«¯å¤„ç†é€»è¾‘
```javascript
// åç«¯åº”è¯¥æœ‰ç±»ä¼¼çš„å¤„ç†é€»è¾‘
if (requestData.password === "") {
  // ä¸æ›´æ–°å¯†ç å­—æ®µ
  delete updateFields.password;
} else {
  // æ›´æ–°å¯†ç ï¼ˆéœ€è¦åŠ å¯†å¤„ç†ï¼‰
  updateFields.password = encrypt(requestData.password);
}
```

### æ¥å£å¥‘çº¦
- `password: ""` - è¡¨ç¤ºä¸ä¿®æ”¹å¯†ç 
- `password: "actual_password"` - è¡¨ç¤ºæ›´æ–°å¯†ç ï¼ˆéœ€è¦å‰ç«¯åŠ å¯†ï¼‰
- å…¶ä»–å­—æ®µæ­£å¸¸æ›´æ–°

## å®‰å…¨è€ƒè™‘

### å·²è§£å†³çš„å®‰å…¨é—®é¢˜
1. **å¯†ç æ³„éœ²**: ä¸å†æ„å¤–ä¼ é€’ç”¨æˆ·å¯†ç 
2. **ä¿¡æ¯è¿‡åº¦æš´éœ²**: åªä¼ é€’å¿…è¦å­—æ®µ
3. **æ•°æ®ä¸€è‡´æ€§**: ç¡®ä¿extensionå­—æ®µæ­£ç¡®å¤„ç†

### ä»éœ€æ³¨æ„çš„å®‰å…¨ç‚¹
1. **å‰ç«¯éªŒè¯**: å‰ç«¯éªŒè¯ä»…ç”¨äºç”¨æˆ·ä½“éªŒï¼Œåç«¯ä»éœ€éªŒè¯
2. **æƒé™æ§åˆ¶**: ç”¨æˆ·åªèƒ½ä¿®æ”¹è‡ªå·±çš„ä¿¡æ¯
3. **æ•°æ®æ ¡éªŒ**: åç«¯éœ€è¦éªŒè¯æ•°æ®æ ¼å¼å’Œæœ‰æ•ˆæ€§

## ç›¸å…³æ–‡ä»¶ä¿®æ”¹

### æ ¸å¿ƒä¿®æ”¹
- `src/utils/userExtension.ts` - ä¿®å¤`prepareUserForBackend`å‡½æ•°

### æ–°å¢æµ‹è¯•
- `src/views/test-password-fix.vue` - å¯†ç ä¿®å¤æµ‹è¯•é¡µé¢
- `src/router/index.ts` - æ·»åŠ æµ‹è¯•è·¯ç”±

### å—å½±å“çš„ç»„ä»¶
- `src/views/User/UserCenterView.vue` - ä¸ªäººä¿¡æ¯ç¼–è¾‘
- `src/stores/auth.ts` - ç”¨æˆ·ä¿¡æ¯æ›´æ–°é€»è¾‘

## æ€»ç»“

é€šè¿‡ä¿®å¤`prepareUserForBackend`å‡½æ•°ï¼Œè§£å†³äº†ä¸ªäººä¿¡æ¯ä¿®æ”¹å¯¼è‡´å¯†ç è¢«æ„å¤–æ›´æ”¹çš„é—®é¢˜ã€‚ä¿®å¤åï¼š

1. **ç”¨æˆ·ä½“éªŒ**: ä¿®æ”¹ä¸ªäººä¿¡æ¯åå¯ä»¥æ­£å¸¸ç™»å½•
2. **æ•°æ®å®‰å…¨**: ä¸ä¼šæ„å¤–ä¼ é€’æ•æ„Ÿä¿¡æ¯
3. **æ¥å£è§„èŒƒ**: ç¬¦åˆåç«¯æ¥å£è¦æ±‚
4. **åŠŸèƒ½å®Œæ•´**: æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯æ›´æ–°åŠŸèƒ½æ­£å¸¸å·¥ä½œ

è¿™ä¸ªä¿®å¤ç¡®ä¿äº†ç”¨æˆ·åœ¨ä½¿ç”¨ä¸ªäººä¿¡æ¯ç¼–è¾‘åŠŸèƒ½æ—¶ä¸ä¼šå½±å“ç™»å½•ï¼Œæå‡äº†ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œç”¨æˆ·ä½“éªŒã€‚ 